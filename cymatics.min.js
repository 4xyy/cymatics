const testToneButton=document.getElementById("test-tone-btn"),pauseButton=document.getElementById("pause-btn"),audioFileInput=document.getElementById("audio-file"),canvas=document.getElementById("chladniCanvas"),fftSizeSelect=document.getElementById("fft-size"),ctx=canvas.getContext("2d");let audioContext,source,analyser,gainNode,isPlaying=!1;const L=canvas.width;function setUpTestTone(){source&&(source.stop(),source.disconnect()),source=audioContext.createOscillator(),source.type="sine",source.frequency.setValueAtTime(440,audioContext.currentTime),analyser=audioContext.createAnalyser(),analyser.fftSize=parseInt(fftSizeSelect.value),gainNode=audioContext.createGain(),gainNode.gain.value=20,source.connect(gainNode),gainNode.connect(analyser),analyser.connect(audioContext.destination),source.start(),console.log("Test tone started (440Hz)"),visualizeChladni(analyser)}function smoothData(e,t){let n=new Uint8Array(e.length);n[0]=e[0];for(let o=1;o<e.length;o++)n[o]=t*e[o]+(1-t)*n[o-1];return n}function visualizeChladni(e){const t=e.frequencyBinCount;let n=new Uint8Array(t);const o=canvas.width/150,a=canvas.height/266;!function t(){e.getByteFrequencyData(n);let i=smoothData(n,.85);console.log("Frequency data (byte):",i),ctx.clearRect(0,0,canvas.width,canvas.height);const s=Math.floor(2+i[100]/255*10),c=Math.floor(2+i[200]/255*10);console.log(`m: ${s}, n: ${c}`);for(let e=0;e<150;e++)for(let t=0;t<266;t++){const n=e*o/L,i=t*a/L,u=Math.cos(c*Math.PI*n)*Math.cos(s*Math.PI*i)-Math.cos(s*Math.PI*n)*Math.cos(c*Math.PI*i),l=255*Math.abs(u);ctx.fillStyle=`rgb(${l}, ${255-l}, ${l})`,ctx.fillRect(e*o,t*a,o-1,a-1)}isPlaying&&requestAnimationFrame(t)}()}audioContext=new(window.AudioContext||window.webkitAudioContext),audioFileInput.addEventListener("change",(function(){const e=this.files[0];if(e){const t=new FileReader;t.onload=function(e){audioContext.decodeAudioData(e.target.result,(function(e){source&&(source.stop(),source.disconnect()),source=audioContext.createBufferSource(),source.buffer=e,analyser=audioContext.createAnalyser(),analyser.fftSize=parseInt(fftSizeSelect.value),gainNode=audioContext.createGain(),gainNode.gain.value=20,source.connect(gainNode),gainNode.connect(analyser),analyser.connect(audioContext.destination),source.start(),console.log("Audio file loaded and playing"),visualizeChladni(analyser)}))},t.readAsArrayBuffer(e)}})),testToneButton.addEventListener("click",(function(){isPlaying?console.log("Test tone is already playing"):("suspended"===audioContext.state&&audioContext.resume(),setUpTestTone(),isPlaying=!0)})),pauseButton.addEventListener("click",(function(){isPlaying&&(source.stop(),console.log("Audio stopped"),isPlaying=!1)}));